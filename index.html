<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Slider Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            transition: background 0.3s;
        }

        .status-indicator.connected {
            background: #44ff44;
            box-shadow: 0 0 10px #44ff44;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .panel h3 {
            margin-bottom: 20px;
            color: #fff;
            font-size: 1.3em;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        button {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.danger {
            background: linear-gradient(45deg, #ff6b6b 0%, #ee5a52 100%);
        }

        button.success {
            background: linear-gradient(45deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 18px;
            min-width: 120px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∑ Camera Slider Control</h1>
        
        <div class="status-bar">
            <div class="connection-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="connectionStatus">Disconnected</span>
            </div>
            <button onclick="connectToSlider()" id="connectBtn">Connect to Slider</button>
            <div id="currentPosition">Position: M1: 0, M2: 0</div>
        </div>
<div class="grid">
            <!-- Motor 1 Controls -->
            <div class="panel">
                <h3>üéØ Motor 1 (Pan/Tilt)</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center;">
                    <label>Start Position:</label>
                    <input type="number" id="m1Start" value="0" style="padding: 8px; border-radius: 5px; border: none;">
                    
                    <label>End Position:</label>
                    <input type="number" id="m1End" value="2000" style="padding: 8px; border-radius: 5px; border: none;">
                    
                    <label>Speed (steps/s):</label>
                    <input type="number" id="m1Speed" value="1000" min="100" max="5000" style="padding: 8px; border-radius: 5px; border: none;">
                </div>
            </div>

            <!-- Motor 2 Controls -->
            <div class="panel">
                <h3>üîÑ Motor 2 (Slide)</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center;">
                    <label>Start Position:</label>
                    <input type="number" id="m2Start" value="0" style="padding: 8px; border-radius: 5px; border: none;">
                    
                    <label>End Position:</label>
                    <input type="number" id="m2End" value="2000" style="padding: 8px; border-radius: 5px; border: none;">
                    
                    <label>Speed (steps/s):</label>
                    <input type="number" id="m2Speed" value="1000" min="100" max="5000" style="padding: 8px; border-radius: 5px; border: none;">
                </div>
            </div>

            <!-- Sequence Settings -->
            <div class="panel">
                <h3>‚öôÔ∏è Sequence Settings</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center;">
                    <label>Cycles (0 = infinite):</label>
                    <input type="number" id="cycles" value="1" min="0" max="100" style="padding: 8px; border-radius: 5px; border: none;">
                    
                    <label style="grid-column: span 2;">
                        <input type="checkbox" id="returnHome" checked style="margin-right: 10px;">
                        Return to start position
                    </label>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="startSequence()" class="success btn-large">‚ñ∂Ô∏è Start</button>
                    <button onclick="stopSequence()" class="danger btn-large">‚èπÔ∏è Stop</button>
                    <button onclick="homeMotors()" class="btn-large">üè† Home</button>
                </div>
            </div>

            <!-- Manual Control -->
            <div class="panel">
                <h3>üéÆ Manual Control</h3>
                <div style="margin-bottom: 15px;">
                    <label>Jog Speed:</label>
                    <input type="range" id="jogSpeed" min="10" max="100" value="50" 
                           oninput="updateJogSpeed(this.value)" style="width: 100%;">
                    <span id="jogSpeedValue" style="display: block; text-align: center;">50%</span>
                </div>
                
                <div style="text-align: center;">
                    <div style="margin-bottom: 10px;">Motor 1</div>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
                        <button onmousedown="startJog('M1', -1)" onmouseup="stopJog()">‚¨ÖÔ∏è Left</button>
                        <button onmousedown="startJog('M1', 1)" onmouseup="stopJog()">‚û°Ô∏è Right</button>
                    </div>
                    
                    <div style="margin-bottom: 10px;">Motor 2</div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onmousedown="startJog('M2', -1)" onmouseup="stopJog()">‚¨ÖÔ∏è Back</button>
                        <button onmousedown="startJog('M2', 1)" onmouseup="stopJog()">‚û°Ô∏è Forward</button>
                    </div>
                </div>
            </div>
<!-- Status Display -->
            <div class="panel">
                <h3>üìä Status</h3>
                <div id="currentPosition" style="
                    background: rgba(0,0,0,0.3); 
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    font-family: monospace;
                    font-size: 14px;
                ">
                    <strong>M1:</strong> 0 steps<br>
                    <strong>M2:</strong> 0 steps
                </div>
                
                <div id="sequenceProgress" style="display: none;"></div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; margin-top: 15px;">
                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
                        <div style="font-size: 12px; opacity: 0.8;">Running</div>
                        <div id="runningStatus" style="font-weight: bold; color: #ff4444;">Stopped</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
                        <div style="font-size: 12px; opacity: 0.8;">Cycle</div>
                        <div id="cycleStatus" style="font-weight: bold;">0</div>
                    </div>
                </div>
            </div>

            <!-- Debug Panel -->
            <div class="panel" id="debugPanel" style="display: none;">
                <h3>üêõ Debug Console</h3>
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="debugMode" onchange="toggleDebugMode()">
                        <span>Enable Debug Mode</span>
                    </label>
                </div>
                
                <div id="debugLog" style="
                    background: rgba(0,0,0,0.5);
                    color: #00ff00;
                    font-family: 'Courier New', monospace;
                    font-size: 12px;
                    padding: 15px;
                    border-radius: 8px;
                    height: 200px;
                    overflow-y: auto;
                    border: 1px solid rgba(255,255,255,0.2);
                "></div>
                
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button onclick="clearDebugLog()" style="padding: 5px 15px; font-size: 12px;">Clear Log</button>
                    <button onclick="exportDebugLog()" style="padding: 5px 15px; font-size: 12px;">Export Log</button>
                </div>
            </div>
        </div>

        <!-- Advanced Controls Section -->
        <div style="margin-top: 30px;">
            <h2 style="text-align: center; margin-bottom: 20px;">üîß Advanced Controls</h2>
            
            <div class="grid">
                <!-- Preset Positions -->
                <div class="panel">
                    <h3>üìç Preset Positions</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                        <button onclick="savePreset(1)" style="padding: 8px; font-size: 12px;">Save P1</button>
                        <button onclick="savePreset(2)" style="padding: 8px; font-size: 12px;">Save P2</button>
                        <button onclick="savePreset(3)" style="padding: 8px; font-size: 12px;">Save P3</button>
                        <button onclick="loadPreset(1)" style="padding: 8px; font-size: 12px;">Load P1</button>
                        <button onclick="loadPreset(2)" style="padding: 8px; font-size: 12px;">Load P2</button>
                        <button onclick="loadPreset(3)" style="padding: 8px; font-size: 12px;">Load P3</button>
                    </div>
                    
                    <div id="presetDisplay" style="
                        background: rgba(0,0,0,0.3);
                        padding: 10px;
                        border-radius: 5px;
                        font-size: 12px;
                        text-align: center;
                    ">
                        No presets saved
                    </div>
                </div>

                <!-- Speed Control -->
                <div class="panel">
                    <h3>‚ö° Speed Control</h3>
                    <div style="margin-bottom: 15px;">
                        <label>Global Speed Multiplier:</label>
                        <input type="range" id="speedMultiplier" min="0.1" max="2" step="0.1" value="1" 
                               oninput="updateSpeedMultiplier(this.value)" style="width: 100%;">
                        <div style="text-align: center; font-weight: bold;" id="speedMultiplierValue">1.0x</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="setSpeedMultiplier(0.5)">0.5x</button>
                        <button onclick="setSpeedMultiplier(1.0)">1.0x</button>
                        <button onclick="setSpeedMultiplier(1.5)">1.5x</button>
                        <button onclick="setSpeedMultiplier(2.0)">2.0x</button>
                    </div>
                </div>
<!-- Emergency Controls -->
            <div class="panel">
                <h3>üö® Emergency Controls</h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button onclick="emergencyStop()" class="danger btn-large" style="
                        background: linear-gradient(45deg, #dc2626 0%, #991b1b 100%);
                        font-size: 20px;
                        padding: 20px;
                        border: 2px solid #fff;
                    ">
                        üõë EMERGENCY STOP
                    </button>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="pauseSequence()" class="btn-large">‚è∏Ô∏è Pause</button>
                        <button onclick="resumeSequence()" class="btn-large">‚ñ∂Ô∏è Resume</button>
                    </div>
                    
                    <button onclick="resetSystem()" class="danger">üîÑ Reset System</button>
                </div>
            </div>
        </div>

        <!-- Quick Actions Bar -->
        <div style="
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 50px;
            display: flex;
            gap: 15px;
            z-index: 1000;
        ">
            <button onclick="quickHome()" style="
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: white;
                padding: 10px 15px;
                border-radius: 25px;
                font-size: 14px;
            ">
                üè† Home
            </button>
            <button onclick="quickStart()" style="
                background: rgba(34,197,94,0.8);
                border: 1px solid rgba(34,197,94,0.5);
                color: white;
                padding: 10px 15px;
                border-radius: 25px;
                font-size: 14px;
            ">
                ‚ñ∂Ô∏è Quick Start
            </button>
            <button onclick="quickStop()" style="
                background: rgba(239,68,68,0.8);
                border: 1px solid rgba(239,68,68,0.5);
                color: white;
                padding: 10px 15px;
                border-radius: 25px;
                font-size: 14px;
            ">
                ‚èπÔ∏è Stop
            </button>
        </div>
    </div>

    <script>
        /* ===================== GLOBAL VARIABLES ===================== */
        let characteristic = null;
        let isConnected = false;
        let debugMode = false;
        let currentJogAxis = null;
        let jogInterval = null;
        let currentSpeedMultiplier = 1.0;
        let currentPositionM1 = 0;
        let currentPositionM2 = 0;
        let isSequenceRunning = false;
        let currentCycle = 0;
        let presets = {
            1: { m1: 0, m2: 0, name: 'Empty' },
            2: { m1: 0, m2: 0, name: 'Empty' },
            3: { m1: 0, m2: 0, name: 'Empty' }
        };

        /* ===================== CONNECTION FUNCTIONS ===================== */
        async function connectToSlider() {
            if (isConnected) {
                log('Already connected');
                return;
            }

            try {
                log('Scanning for Camera Slider...');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'CameraSlider' }],
                    optionalServices: ['12345678-1234-1234-1234-1234567890ab']
                });

                log('Connecting to device...');
                const server = await device.connect();
                const service = await server.getPrimaryService('12345678-1234-1234-1234-1234567890ab');
                characteristic = await service.getCharacteristic('abcd1234-1234-1234-1234-abcdef123456');

                isConnected = true;
                updateConnectionStatus();
                log('‚úÖ Connected successfully!');
                
                // Initialize with current values
                sendAllSettings();
                
            } catch (error) {
                log('‚ùå Connection failed: ' + error.message);
                updateConnectionStatus();
            }
        }

        function disconnect() {
            if (characteristic && characteristic.service.device.gatt.connected) {
                characteristic.service.device.gatt.disconnect();
            }
            isConnected = false;
            characteristic = null;
            updateConnectionStatus();
            log('Disconnected');
        }

        function updateConnectionStatus() {
            const indicator = document.getElementById('statusIndicator');
            const status = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (isConnected) {
                indicator.classList.add('connected');
                status.textContent = 'Connected';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
            } else {
                indicator.classList.remove('connected');
                status.textContent = 'Disconnected';
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
            }
        }
/* ===================== COMMUNICATION FUNCTIONS ===================== */
        async function sendCommand(command) {
            if (!characteristic) {
                log('‚ùå Not connected');
                return false;
            }

            try {
                const encoder = new TextEncoder();
                await characteristic.writeValue(encoder.encode(command));
                log('üì§ ' + command);
                return true;
            } catch (error) {
                log('‚ùå Send failed: ' + error.message);
                return false;
            }
        }

        function sendAllSettings() {
            if (!isConnected) return;
            
            const m1Start = document.getElementById('m1Start').value;
            const m1End = document.getElementById('m1End').value;
            const m1Speed = document.getElementById('m1Speed').value;
            const m2Start = document.getElementById('m2Start').value;
            const m2End = document.getElementById('m2End').value;
            const m2Speed = document.getElementById('m2Speed').value;
            const cycles = document.getElementById('cycles').value;
            const returnHome = document.getElementById('returnHome').checked;

            sendCommand(`M1S:${m1Start}`);
            sendCommand(`M1E:${m1End}`);
            sendCommand(`M1SPD:${Math.round(m1Speed * currentSpeedMultiplier)}`);
            sendCommand(`M2S:${m2Start}`);
            sendCommand(`M2E:${m2End}`);
            sendCommand(`M2SPD:${Math.round(m2Speed * currentSpeedMultiplier)}`);
            sendCommand(`CYCLES:${cycles}`);
            sendCommand(`RETURN:${returnHome ? 1 : 0}`);
        }

        /* ===================== SEQUENCE CONTROL ===================== */
        function startSequence() {
            if (!isConnected) {
                log('‚ùå Not connected to slider');
                return;
            }

            sendAllSettings();
            setTimeout(() => {
                sendCommand('RUN');
                isSequenceRunning = true;
                updateSequenceStatus();
                log('‚ñ∂Ô∏è Sequence started');
            }, 500);
        }

        function stopSequence() {
            if (!isConnected) return;
            
            sendCommand('STOP');
            isSequenceRunning = false;
            currentCycle = 0;
            updateSequenceStatus();
            log('‚èπÔ∏è Sequence stopped');
        }

        function pauseSequence() {
            if (!isConnected || !isSequenceRunning) return;
            
            sendCommand('PAUSE');
            log('‚è∏Ô∏è Sequence paused');
        }

        function resumeSequence() {
            if (!isConnected) return;
            
            sendCommand('RESUME');
            log('‚ñ∂Ô∏è Sequence resumed');
        }

        function homeMotors() {
            if (!isConnected) return;
            
            sendCommand('HOME');
            currentPositionM1 = 0;
            currentPositionM2 = 0;
            updatePositionDisplay();
            log('üè† Homing motors');
        }

        /* ===================== MANUAL JOG CONTROL ===================== */
        function startJog(axis, direction) {
            if (!isConnected) return;

            const jogSpeedValue = document.getElementById('jogSpeed').value;
            const speed = direction * jogSpeedValue;
            
            currentJogAxis = axis;
            sendCommand(`JOGSLIDER:${axis}:${speed}`);
            
            log(`üéÆ Jogging ${axis} at ${speed}%`);
        }

        function stopJog() {
            if (!isConnected || !currentJogAxis) return;

            sendCommand(`JOGSLIDER:${currentJogAxis}:0`);
            currentJogAxis = null;
            log('üõë Jog stopped');
        }

        function updateJogSpeed(value) {
            document.getElementById('jogSpeedValue').textContent = value + '%';
        }

        /* ===================== EMERGENCY FUNCTIONS ===================== */
        function emergencyStop() {
            if (!isConnected) return;

            sendCommand('STOP');
            stopJog();
            isSequenceRunning = false;
            currentCycle = 0;
            updateSequenceStatus();
            
            // Visual feedback
            document.body.style.background = 'linear-gradient(45deg, #dc2626, #991b1b)';
            setTimeout(() => {
                document.body.style.background = '';
            }, 1000);
            
            log('üö® EMERGENCY STOP ACTIVATED');
        }

        function resetSystem() {
            if (confirm('Reset system to default settings?')) {
                document.getElementById('m1Start').value = 0;
                document.getElementById('m1End').value = 2000;
                document.getElementById('m1Speed').value = 1000;
                document.getElementById('m2Start').value = 0;
                document.getElementById('m2End').value = 2000;
                document.getElementById('m2Speed').value = 1000;
                document.getElementById('cycles').value = 1;
                document.getElementById('returnHome').checked = true;
                
                setSpeedMultiplier(1.0);
                sendAllSettings();
                log('üîÑ System reset to defaults');
            }
        }
/* ===================== QUICK ACTIONS ===================== */
        function quickHome() {
            homeMotors();
        }

        function quickStart() {
            startSequence();
        }

        function quickStop() {
            stopSequence();
        }

        /* ===================== SPEED CONTROL ===================== */
        function updateSpeedMultiplier(value) {
            currentSpeedMultiplier = parseFloat(value);
            document.getElementById('speedMultiplierValue').textContent = value + 'x';
            
            if (isConnected) {
                // Update motor speeds with new multiplier
                const m1Speed = document.getElementById('m1Speed').value;
                const m2Speed = document.getElementById('m2Speed').value;
                sendCommand(`M1SPD:${Math.round(m1Speed * currentSpeedMultiplier)}`);
                sendCommand(`M2SPD:${Math.round(m2Speed * currentSpeedMultiplier)}`);
            }
        }

        function setSpeedMultiplier(value) {
            document.getElementById('speedMultiplier').value = value;
            updateSpeedMultiplier(value);
        }

        /* ===================== PRESET FUNCTIONS ===================== */
        function savePreset(slot) {
            const m1Pos = currentPositionM1;
            const m2Pos = currentPositionM2;
            
            presets[slot] = {
                m1: m1Pos,
                m2: m2Pos,
                name: `Preset ${slot}`
            };
            
            // Save to localStorage
            localStorage.setItem('cameraSliderPresets', JSON.stringify(presets));
            
            updatePresetDisplay();
            log(`üíæ Preset ${slot} saved: M1=${m1Pos}, M2=${m2Pos}`);
        }

        function loadPreset(slot) {
            if (!isConnected) {
                log('‚ùå Not connected');
                return;
            }

            const preset = presets[slot];
            if (preset && (preset.m1 !== 0 || preset.m2 !== 0)) {
                sendCommand(`JOGSLIDER:M1:0`); // Stop any movement
                sendCommand(`JOGSLIDER:M2:0`);
                
                setTimeout(() => {
                    sendCommand(`M1S:${preset.m1}`);
                    sendCommand(`M1E:${preset.m1}`);
                    sendCommand(`M2S:${preset.m2}`);
                    sendCommand(`M2E:${preset.m2}`);
                    sendCommand('RUN');
                }, 100);
                
                log(`üìç Moving to Preset ${slot}: M1=${preset.m1}, M2=${preset.m2}`);
            } else {
                log(`‚ùå Preset ${slot} is empty`);
            }
        }

        function updatePresetDisplay() {
            const display = document.getElementById('presetDisplay');
            let html = '';
            
            for (let i = 1; i <= 3; i++) {
                const preset = presets[i];
                if (preset.m1 !== 0 || preset.m2 !== 0) {
                    html += `P${i}: M1=${preset.m1}, M2=${preset.m2}<br>`;
                } else {
                    html += `P${i}: Empty<br>`;
                }
            }
            
            display.innerHTML = html || 'No presets saved';
        }

        /* ===================== STATUS UPDATE FUNCTIONS ===================== */
        function updatePositionDisplay() {
            const display = document.getElementById('currentPosition');
            display.innerHTML = `<strong>M1:</strong> ${currentPositionM1} steps<br><strong>M2:</strong> ${currentPositionM2} steps`;
        }

        function updateSequenceStatus() {
            const runningStatus = document.getElementById('runningStatus');
            const cycleStatus = document.getElementById('cycleStatus');
            
            runningStatus.textContent = isSequenceRunning ? 'Running' : 'Stopped';
            runningStatus.style.color = isSequenceRunning ? '#22c55e' : '#ef4444';
            
            cycleStatus.textContent = currentCycle;
        }

        /* ===================== DEBUG FUNCTIONS ===================== */
        function toggleDebugMode() {
            debugMode = document.getElementById('debugMode').checked;
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.style.display = debugMode ? 'block' : 'none';
            
            log(debugMode ? 'üêõ Debug mode enabled' : 'üîß Debug mode disabled');
        }

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            console.log(logEntry);
            
            if (debugMode) {
                const debugLog = document.getElementById('debugLog');
                debugLog.innerHTML += logEntry + '<br>';
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }

        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = '';
            log('Debug log cleared');
        }

        function exportDebugLog() {
            const debugLog = document.getElementById('debugLog');
            const logContent = debugLog.innerHTML.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
            
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `camera_slider_log_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('üìÑ Debug log exported');
        }
/* ===================== QUICK ACTIONS ===================== */
        function quickHome() {
            homeMotors();
        }

        function quickStart() {
            startSequence();
        }

        function quickStop() {
            stopSequence();
        }

        /* ===================== SPEED CONTROL ===================== */
        function updateSpeedMultiplier(value) {
            currentSpeedMultiplier = parseFloat(value);
            document.getElementById('speedMultiplierValue').textContent = value + 'x';
            
            if (isConnected) {
                // Update motor speeds with new multiplier
                const m1Speed = document.getElementById('m1Speed').value;
                const m2Speed = document.getElementById('m2Speed').value;
                sendCommand(`M1SPD:${Math.round(m1Speed * currentSpeedMultiplier)}`);
                sendCommand(`M2SPD:${Math.round(m2Speed * currentSpeedMultiplier)}`);
            }
        }

        function setSpeedMultiplier(value) {
            document.getElementById('speedMultiplier').value = value;
            updateSpeedMultiplier(value);
        }

        /* ===================== PRESET FUNCTIONS ===================== */
        function savePreset(slot) {
            const m1Pos = currentPositionM1;
            const m2Pos = currentPositionM2;
            
            presets[slot] = {
                m1: m1Pos,
                m2: m2Pos,
                name: `Preset ${slot}`
            };
            
            // Save to localStorage
            localStorage.setItem('cameraSliderPresets', JSON.stringify(presets));
            
            updatePresetDisplay();
            log(`üíæ Preset ${slot} saved: M1=${m1Pos}, M2=${m2Pos}`);
        }

        function loadPreset(slot) {
            if (!isConnected) {
                log('‚ùå Not connected');
                return;
            }

            const preset = presets[slot];
            if (preset && (preset.m1 !== 0 || preset.m2 !== 0)) {
                sendCommand(`JOGSLIDER:M1:0`); // Stop any movement
                sendCommand(`JOGSLIDER:M2:0`);
                
                setTimeout(() => {
                    sendCommand(`M1S:${preset.m1}`);
                    sendCommand(`M1E:${preset.m1}`);
                    sendCommand(`M2S:${preset.m2}`);
                    sendCommand(`M2E:${preset.m2}`);
                    sendCommand('RUN');
                }, 100);
                
                log(`üìç Moving to Preset ${slot}: M1=${preset.m1}, M2=${preset.m2}`);
            } else {
                log(`‚ùå Preset ${slot} is empty`);
            }
        }

        function updatePresetDisplay() {
            const display = document.getElementById('presetDisplay');
            let html = '';
            
            for (let i = 1; i <= 3; i++) {
                const preset = presets[i];
                if (preset.m1 !== 0 || preset.m2 !== 0) {
                    html += `P${i}: M1=${preset.m1}, M2=${preset.m2}<br>`;
                } else {
                    html += `P${i}: Empty<br>`;
                }
            }
            
            display.innerHTML = html || 'No presets saved';
        }

        /* ===================== STATUS UPDATE FUNCTIONS ===================== */
        function updatePositionDisplay() {
            const display = document.getElementById('currentPosition');
            display.innerHTML = `<strong>M1:</strong> ${currentPositionM1} steps<br><strong>M2:</strong> ${currentPositionM2} steps`;
        }

        function updateSequenceStatus() {
            const runningStatus = document.getElementById('runningStatus');
            const cycleStatus = document.getElementById('cycleStatus');
            
            runningStatus.textContent = isSequenceRunning ? 'Running' : 'Stopped';
            runningStatus.style.color = isSequenceRunning ? '#22c55e' : '#ef4444';
            
            cycleStatus.textContent = currentCycle;
        }

        /* ===================== DEBUG FUNCTIONS ===================== */
        function toggleDebugMode() {
            debugMode = document.getElementById('debugMode').checked;
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.style.display = debugMode ? 'block' : 'none';
            
            log(debugMode ? 'üêõ Debug mode enabled' : 'üîß Debug mode disabled');
        }

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            console.log(logEntry);
            
            if (debugMode) {
                const debugLog = document.getElementById('debugLog');
                debugLog.innerHTML += logEntry + '<br>';
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }

        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = '';
            log('Debug log cleared');
        }

        function exportDebugLog() {
            const debugLog = document.getElementById('debugLog');
            const logContent = debugLog.innerHTML.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
            
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `camera_slider_log_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('üìÑ Debug log exported');
        }
/* ===================== INPUT VALIDATION ===================== */
        function validateInputs() {
            const inputs = [
                { id: 'm1Start', min: -10000, max: 10000 },
                { id: 'm1End', min: -10000, max: 10000 },
                { id: 'm1Speed', min: 100, max: 5000 },
                { id: 'm2Start', min: -10000, max: 10000 },
                { id: 'm2End', min: -10000, max: 10000 },
                { id: 'm2Speed', min: 100, max: 5000 },
                { id: 'cycles', min: 1, max: 100 }
            ];

            let isValid = true;
            
            inputs.forEach(input => {
                const element = document.getElementById(input.id);
                const value = parseInt(element.value);
                
                if (isNaN(value) || value < input.min || value > input.max) {
                    element.style.border = '2px solid #ef4444';
                    isValid = false;
                } else {
                    element.style.border = '';
                }
            });

            return isValid;
        }

        function validateAndSend() {
            if (validateInputs()) {
                sendAllSettings();
                return true;
            } else {
                log('‚ùå Invalid input values detected');
                return false;
            }
        }

        /* ===================== INITIALIZATION ===================== */
        function initializeApp() {
            // Load presets from localStorage
            const savedPresets = localStorage.getItem('cameraSliderPresets');
            if (savedPresets) {
                try {
                    presets = JSON.parse(savedPresets);
                    updatePresetDisplay();
                } catch (e) {
                    log('‚ö†Ô∏è Failed to load saved presets');
                }
            }

            // Add input event listeners for real-time validation
            const inputs = ['m1Start', 'm1End', 'm1Speed', 'm2Start', 'm2End', 'm2Speed', 'cycles'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => {
                        validateInputs();
                        if (isConnected) {
                            setTimeout(() => {
                                validateAndSend();
                            }, 500); // Debounce
                        }
                    });
                }
            });

            // Add change listeners for checkboxes
            const returnHome = document.getElementById('returnHome');
            if (returnHome) {
                returnHome.addEventListener('change', () => {
                    if (isConnected) {
                        sendCommand(`RETURN:${returnHome.checked ? 1 : 0}`);
                    }
                });
            }

            // Initialize position display
            updatePositionDisplay();
            updateSequenceStatus();
            updatePresetDisplay();

            // Check for Web Bluetooth support
            if (!navigator.bluetooth) {
                log('‚ùå Web Bluetooth not supported in this browser');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').textContent = 'Bluetooth Not Supported';
            }

            log('üöÄ Camera Slider Controller initialized');
        }

        /* ===================== MOUSE EVENT HANDLERS ===================== */
        // Jog button mouse events
        function attachJogEvents() {
            const jogButtons = [
                { id: 'jogM1Neg', axis: 'M1', direction: -1 },
                { id: 'jogM1Pos', axis: 'M1', direction: 1 },
                { id: 'jogM2Neg', axis: 'M2', direction: -1 },
                { id: 'jogM2Pos', axis: 'M2', direction: 1 }
            ];

            jogButtons.forEach(btn => {
                const element = document.getElementById(btn.id);
                if (element) {
                    // Mouse events
                    element.addEventListener('mousedown', () => startJog(btn.axis, btn.direction));
                    element.addEventListener('mouseup', stopJog);
                    element.addEventListener('mouseleave', stopJog);
                    
                    // Touch events for mobile
                    element.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        startJog(btn.axis, btn.direction);
                    });
                    element.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        stopJog();
                    });
                }
            });
        }

        /* ===================== KEYBOARD SHORTCUTS ===================== */
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (event) => {
                // Only process if not typing in an input field
                if (document.activeElement.tagName === 'INPUT') return;

                switch(event.code) {
                    case 'Space':
                        event.preventDefault();
                        if (isSequenceRunning) {
                            pauseSequence();
                        } else {
                            startSequence();
                        }
                        break;
                    case 'KeyH':
                        event.preventDefault();
                        homeMotors();
                        break;
                    case 'KeyS':
                        event.preventDefault();
                        stopSequence();
                        break;
                    case 'Escape':
                        event.preventDefault();
                        emergencyStop();
                        break;
                    case 'ArrowLeft':
                        event.preventDefault();
                        startJog('M1', -1);
                        break;
                    case 'ArrowRight':
                        event.preventDefault();
                        startJog('M1', 1);
                        break;
                    case 'ArrowUp':
                        event.preventDefault();
                        startJog('M2', 1);
                        break;
                    case 'ArrowDown':
                        event.preventDefault();
                        startJog('M2', -1);
                        break;
                }
            });

            document.addEventListener('keyup', (event) => {
                if (document.activeElement.tagName === 'INPUT') return;
                
                switch(event.code) {
                    case 'ArrowLeft':
                    case 'ArrowRight':
                    case 'ArrowUp':
                    case 'ArrowDown':
                        event.preventDefault();
                        stopJog();
                        break;
                }
            });
        }
/* ===================== TOUCH EVENTS FOR MOBILE ===================== */
        function setupTouchEvents() {
            // Prevent default touch behaviors for better mobile experience
            document.addEventListener('touchmove', (e) => {
                // Only prevent scrolling on control elements, not the whole page
                if (e.target.classList.contains('btn') || 
                    e.target.classList.contains('slider') ||
                    e.target.parentElement.classList.contains('control-group')) {
                    e.preventDefault();
                }
            }, { passive: false });

            // Add haptic feedback for supported devices
            function addHapticFeedback(element) {
                element.addEventListener('touchstart', () => {
                    if ('vibrate' in navigator) {
                        navigator.vibrate(10); // Short vibration
                    }
                });
            }

            // Apply haptic feedback to buttons
            document.querySelectorAll('.btn').forEach(addHapticFeedback);
            document.querySelectorAll('.danger').forEach(addHapticFeedback);
        }

        /* ===================== RESPONSIVE DESIGN HELPERS ===================== */
        function adjustForScreenSize() {
            const panels = document.querySelectorAll('.panel');
            const quickActions = document.querySelector('.quick-actions-bar');
            
            // Adjust layout for small screens
            if (window.innerWidth < 768) {
                panels.forEach(panel => {
                    panel.style.marginBottom = '15px';
                });
                
                // Move quick actions to top on mobile
                if (quickActions) {
                    quickActions.style.position = 'fixed';
                    quickActions.style.top = '10px';
                    quickActions.style.bottom = 'auto';
                }
            } else {
                // Reset for larger screens
                if (quickActions) {
                    quickActions.style.position = 'fixed';
                    quickActions.style.top = 'auto';
                    quickActions.style.bottom = '20px';
                }
            }
        }

        /* ===================== AUTO-UPDATE STATUS ===================== */
        function startStatusUpdates() {
            // Update position display every 500ms when connected
            setInterval(() => {
                if (isConnected) {
                    // In a real implementation, you'd receive position updates from the device
                    // For now, we'll simulate based on jog commands
                    updatePositionDisplay();
                }
            }, 500);

            // Check connection status every 5 seconds
            setInterval(() => {
                if (isConnected && characteristic) {
                    // Test connection by sending a ping
                    sendCommand('PING').catch(() => {
                        // Connection lost
                        isConnected = false;
                        characteristic = null;
                        updateConnectionStatus();
                        log('‚ö†Ô∏è Connection lost');
                    });
                }
            }, 5000);
        }

        /* ===================== ERROR HANDLING ===================== */
        function handleGlobalError(error) {
            log('‚ùå Error: ' + error.message);
            
            // If it's a Bluetooth error, try to reconnect
            if (error.message.includes('bluetooth') || error.message.includes('GATT')) {
                isConnected = false;
                characteristic = null;
                updateConnectionStatus();
                
                // Show reconnect option
                if (confirm('Bluetooth connection lost. Try to reconnect?')) {
                    setTimeout(connectToSlider, 1000);
                }
            }
        }

        // Global error handler
        window.addEventListener('error', (event) => {
            handleGlobalError(event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            handleGlobalError(event.reason);
            event.preventDefault();
        });

        /* ===================== DATA PERSISTENCE ===================== */
        function saveAppState() {
            const state = {
                m1Start: document.getElementById('m1Start').value,
                m1End: document.getElementById('m1End').value,
                m1Speed: document.getElementById('m1Speed').value,
                m2Start: document.getElementById('m2Start').value,
                m2End: document.getElementById('m2End').value,
                m2Speed: document.getElementById('m2Speed').value,
                cycles: document.getElementById('cycles').value,
                returnHome: document.getElementById('returnHome').checked,
                jogSpeed: document.getElementById('jogSpeed').value,
                speedMultiplier: document.getElementById('speedMultiplier').value,
                presets: presets,
                debugMode: debugMode
            };
            
            localStorage.setItem('cameraSliderState', JSON.stringify(state));
        }

        function loadAppState() {
            const savedState = localStorage.getItem('cameraSliderState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    
                    // Restore form values
                    if (state.m1Start !== undefined) document.getElementById('m1Start').value = state.m1Start;
                    if (state.m1End !== undefined) document.getElementById('m1End').value = state.m1End;
                    if (state.m1Speed !== undefined) document.getElementById('m1Speed').value = state.m1Speed;
                    if (state.m2Start !== undefined) document.getElementById('m2Start').value = state.m2Start;
                    if (state.m2End !== undefined) document.getElementById('m2End').value = state.m2End;
                    if (state.m2Speed !== undefined) document.getElementById('m2Speed').value = state.m2Speed;
                    if (state.cycles !== undefined) document.getElementById('cycles').value = state.cycles;
                    if (state.returnHome !== undefined) document.getElementById('returnHome').checked = state.returnHome;
                    if (state.jogSpeed !== undefined) {
                        document.getElementById('jogSpeed').value = state.jogSpeed;
                        updateJogSpeed(state.jogSpeed);
                    }
                    if (state.speedMultiplier !== undefined) {
                        document.getElementById('speedMultiplier').value = state.speedMultiplier;
                        updateSpeedMultiplier(state.speedMultiplier);
                    }
                    if (state.presets) presets = state.presets;
                    if (state.debugMode !== undefined) {
                        document.getElementById('debugMode').checked = state.debugMode;
                        toggleDebugMode();
                    }
                    
                    log('üìÅ App state restored');
                } catch (e) {
                    log('‚ö†Ô∏è Failed to restore app state');
                }
            }
        }

        // Auto-save state when values change
        function setupAutoSave() {
            const inputs = ['m1Start', 'm1End', 'm1Speed', 'm2Start', 'm2End', 'm2Speed', 'cycles', 'jogSpeed', 'speedMultiplier'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => {
                        setTimeout(saveAppState, 1000); // Debounced save
                    });
                }
            });

            const checkbox = document.getElementById('returnHome');
            if (checkbox) {
                checkbox.addEventListener('change', saveAppState);
            }
        }
/* ===================== WINDOW LOAD HANDLER ===================== */
        window.addEventListener('load', () => {
            initializeApp();
            loadAppState();
            setupAutoSave();
            attachJogEvents();
            setupKeyboardShortcuts();
            setupTouchEvents();
            startStatusUpdates();
            
            // Adjust for screen size
            adjustForScreenSize();
            window.addEventListener('resize', adjustForScreenSize);
            
            // Save state before page unload
            window.addEventListener('beforeunload', saveAppState);
            
            log('üéâ Camera Slider Controller fully loaded');
        });

        /* ===================== UTILITY FUNCTIONS ===================== */
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function calculateEstimatedTime() {
            if (!isConnected) return 'N/A';
            
            const m1Distance = Math.abs(parseInt(document.getElementById('m1End').value) - 
                                      parseInt(document.getElementById('m1Start').value));
            const m2Distance = Math.abs(parseInt(document.getElementById('m2End').value) - 
                                      parseInt(document.getElementById('m2Start').value));
            const m1Speed = parseInt(document.getElementById('m1Speed').value) * currentSpeedMultiplier;
            const m2Speed = parseInt(document.getElementById('m2Speed').value) * currentSpeedMultiplier;
            const cycles = parseInt(document.getElementById('cycles').value) || 1;
            
            const m1Time = m1Distance / m1Speed;
            const m2Time = m2Distance / m2Speed;
            const timePerCycle = Math.max(m1Time, m2Time);
            const totalTime = timePerCycle * cycles * (document.getElementById('returnHome').checked ? 2 : 1);
            
            return formatTime(Math.round(totalTime));
        }

        function updateEstimatedTime() {
            const timeDisplay = document.getElementById('estimatedTime');
            if (timeDisplay) {
                timeDisplay.textContent = calculateEstimatedTime();
            }
        }

        /* ===================== ADVANCED FEATURES ===================== */
        function createSequenceFromPresets() {
            const preset1 = presets[1];
            const preset2 = presets[2];
            
            if ((preset1.m1 !== 0 || preset1.m2 !== 0) && 
                (preset2.m1 !== 0 || preset2.m2 !== 0)) {
                
                document.getElementById('m1Start').value = preset1.m1;
                document.getElementById('m2Start').value = preset1.m2;
                document.getElementById('m1End').value = preset2.m1;
                document.getElementById('m2End').value = preset2.m2;
                
                if (isConnected) {
                    sendAllSettings();
                }
                
                updateEstimatedTime();
                log('üé¨ Sequence created from presets 1‚Üí2');
            } else {
                log('‚ùå Need both presets 1 and 2 to create sequence');
            }
        }

        function mirrorSequence() {
            const m1Start = document.getElementById('m1Start').value;
            const m1End = document.getElementById('m1End').value;
            const m2Start = document.getElementById('m2Start').value;
            const m2End = document.getElementById('m2End').value;
            
            // Swap start and end positions
            document.getElementById('m1Start').value = m1End;
            document.getElementById('m1End').value = m1Start;
            document.getElementById('m2Start').value = m2End;
            document.getElementById('m2End').value = m2Start;
            
            if (isConnected) {
                sendAllSettings();
            }
            
            updateEstimatedTime();
            log('ü™û Sequence mirrored');
        }

        /* ===================== EXPORT/IMPORT SETTINGS ===================== */
        function exportSettings() {
            const settings = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                m1Start: document.getElementById('m1Start').value,
                m1End: document.getElementById('m1End').value,
                m1Speed: document.getElementById('m1Speed').value,
                m2Start: document.getElementById('m2Start').value,
                m2End: document.getElementById('m2End').value,
                m2Speed: document.getElementById('m2Speed').value,
                cycles: document.getElementById('cycles').value,
                returnHome: document.getElementById('returnHome').checked,
                jogSpeed: document.getElementById('jogSpeed').value,
                speedMultiplier: document.getElementById('speedMultiplier').value,
                presets: presets
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `camera_slider_settings_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('üì§ Settings exported');
        }

        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const settings = JSON.parse(e.target.result);
                            
                            // Apply settings
                            if (settings.m1Start !== undefined) document.getElementById('m1Start').value = settings.m1Start;
                            if (settings.m1End !== undefined) document.getElementById('m1End').value = settings.m1End;
                            if (settings.m1Speed !== undefined) document.getElementById('m1Speed').value = settings.m1Speed;
                            if (settings.m2Start !== undefined) document.getElementById('m2Start').value = settings.m2Start;
                            if (settings.m2End !== undefined) document.getElementById('m2End').value = settings.m2End;
                            if (settings.m2Speed !== undefined) document.getElementById('m2Speed').value = settings.m2Speed;
                            if (settings.cycles !== undefined) document.getElementById('cycles').value = settings.cycles;
                            if (settings.returnHome !== undefined) document.getElementById('returnHome').checked = settings.returnHome;
                            if (settings.jogSpeed !== undefined) {
                                document.getElementById('jogSpeed').value = settings.jogSpeed;
                                updateJogSpeed(settings.jogSpeed);
                            }
                            if (settings.speedMultiplier !== undefined) {
                                document.getElementById('speedMultiplier').value = settings.speedMultiplier;
                                updateSpeedMultiplier(settings.speedMultiplier);
                            }
                            if (settings.presets) {
                                presets = settings.presets;
                                updatePresetDisplay();
                            }
                            
                            if (isConnected) {
                                sendAllSettings();
                            }
                            
                            updateEstimatedTime();
                            saveAppState();
                            log('üì• Settings imported successfully');
                        } catch (error) {
                            log('‚ùå Failed to import settings: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }
    </script>
</body>
</html>



















