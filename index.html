<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Slider Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: 90vh;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .connection-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .connect-btn {
            padding: 12px 25px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }
        
        .connect-btn:hover { 
            background: #0056b3; 
            transform: translateY(-2px);
        }
        
        .connection-status {
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .connected { 
            background: #d4edda; 
            color: #155724; 
            border: 2px solid #c3e6cb;
        }
        
        .disconnected { 
            background: #f8d7da; 
            color: #721c24; 
            border: 2px solid #f1b0b7;
        }
.status-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #007bff;
        }
        
        .status-card h3 {
            color: #495057;
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        
        .status-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #007bff;
        }
        
        .controls-section {
            padding: 25px 30px;
        }
        
        .section-title {
            font-size: 1.4em;
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
            font-weight: 600;
        }
        
        .jog-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 25px;
            margin-bottom: 35px;
        }
        
        .jog-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }
        
        .jog-group h3 {
            margin-bottom: 15px;
            color: #495057;
            text-align: center;
            font-size: 1.2em;
        }
        
        .slider-container {
            position: relative;
            margin: 15px 0;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .slider::-webkit-slider-thumb:hover {
            background: #0056b3;
            transform: scale(1.1);
        }
.slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .slider-value {
            font-weight: bold;
            color: #007bff;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #dc3545;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        
        .preset-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            margin-bottom: 25px;
        }
        
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .preset-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }
        
        .preset-group h4 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 1.1em;
        }
.input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        
        .input-group label {
            min-width: 80px;
            font-weight: 500;
        }
        
        .input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .sequence-section {
            background: #e3f2fd;
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid #2196f3;
            margin-bottom: 25px;
        }
        
        .sequence-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .jog-section {
            background: #fff3e0;
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid #ff9800;
            margin-bottom: 25px;
        }
        
        .jog-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .jog-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            background: #ff9800;
            color: white;
            user-select: none;
        }
        
        .jog-btn:hover {
            background: #f57c00;
            transform: scale(1.05);
        }
        
        .jog-btn:active {
            transform: scale(0.95);
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                min-height: 95vh;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .connection-section {
                flex-direction: column;
                gap: 10px;
            }
.status-section {
                grid-template-columns: 1fr;
                padding: 20px 15px;
            }
            
            .controls-section {
                padding: 20px 15px;
            }
            
            .jog-controls {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .control-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .preset-grid {
                grid-template-columns: 1fr;
            }
            
            .sequence-controls {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .jog-buttons {
                grid-template-columns: repeat(3, 1fr);
                max-width: 300px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .connect-btn {
                padding: 10px 20px;
                font-size: 1em;
            }
            
            .control-buttons {
                grid-template-columns: 1fr;
            }
            
            .sequence-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Camera Slider Control</h1>
            <div class="connection-section">
                <button class="connect-btn" onclick="connectBluetooth()">üì± Connect Bluetooth</button>
                <div class="connection-status disconnected" id="connectionStatus">
                    ‚ùå Disconnected
                </div>
            </div>
        </div>
        
        <div class="status-section">
            <div class="status-card">
                <h3>Motor 1 Position</h3>
                <div class="value" id="m1Position">0</div>
            </div>
            <div class="status-card">
                <h3>Motor 2 Position</h3>
                <div class="value" id="m2Position">0</div>
            </div>
            <div class="status-card">
                <h3>Current Cycle</h3>
                <div class="value" id="currentCycle">0</div>
            </div>
            <div class="status-card">
                <h3>Status</h3>
                <div class="value" id="runStatus">Stopped</div>
            </div>
        </div>
<div class="controls-section">
            <h2 class="section-title">Motor Control</h2>
            
            <div class="jog-controls">
                <div class="jog-group">
                    <h3>Motor 1</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Start Position</span>
                            <span class="slider-value" id="m1StartValue">0</span>
                        </div>
                        <input type="range" class="slider" id="m1Start" min="-5000" max="5000" value="0" 
                               oninput="updateSliderValue('m1Start')">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>End Position</span>
                            <span class="slider-value" id="m1EndValue">2000</span>
                        </div>
                        <input type="range" class="slider" id="m1End" min="-5000" max="5000" value="2000" 
                               oninput="updateSliderValue('m1End')">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Speed</span>
                            <span class="slider-value" id="m1SpeedValue">2000</span>
                        </div>
                        <input type="range" class="slider" id="m1Speed" min="100" max="6000" value="2000" 
                               oninput="updateSliderValue('m1Speed')">
                    </div>
                </div>
                
                <div class="jog-group">
                    <h3>Motor 2</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Start Position</span>
                            <span class="slider-value" id="m2StartValue">0</span>
                        </div>
                        <input type="range" class="slider" id="m2Start" min="-5000" max="5000" value="0" 
                               oninput="updateSliderValue('m2Start')">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>End Position</span>
                            <span class="slider-value" id="m2EndValue">2000</span>
                        </div>
                        <input type="range" class="slider" id="m2End" min="-5000" max="5000" value="2000" 
                               oninput="updateSliderValue('m2End')">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Speed</span>
                            <span class="slider-value" id="m2SpeedValue">2000</span>
                        </div>
                        <input type="range" class="slider" id="m2Speed" min="100" max="6000" value="2000" 
                               oninput="updateSliderValue('m2Speed')">
                    </div>
                </div>
                
                <div class="jog-group">
                    <h3>Sequence Settings</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Cycles</span>
                            <span class="slider-value" id="cyclesValue">‚àû</span>
                        </div>
                        <input type="range" class="slider" id="cycles" min="0" max="10" value="0" 
                               oninput="updateCyclesValue()">
                    </div>
                    <div style="margin-top: 15px;">
                        <label>
                            <input type="checkbox" id="returnEnabled" checked onchange="updateReturnEnabled()">
                            Return to Start
                        </label>
                    </div>
                </div>
            </div>
<div class="control-buttons">
                <button class="btn btn-primary" onclick="sendCommand('RUN')">‚ñ∂Ô∏è Start</button>
                <button class="btn btn-secondary" onclick="sendCommand('STOP')">‚èπÔ∏è Stop</button>
                <button class="btn btn-info" onclick="sendCommand('HOME')">üè† Home</button>
            </div>
        </div>
        
        <div class="preset-section">
            <h2 class="section-title">Quick Presets</h2>
            <div class="preset-grid">
                <div class="preset-group">
                    <h4>üé¨ Film Modes</h4>
                    <div class="input-group">
                        <button class="btn btn-info" onclick="applyPreset('slowPan')">Slow Pan</button>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-info" onclick="applyPreset('fastMove')">Fast Move</button>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-info" onclick="applyPreset('timeLoop')">Time Loop</button>
                    </div>
                </div>
                
                <div class="preset-group">
                    <h4>üìê Test Patterns</h4>
                    <div class="input-group">
                        <button class="btn btn-info" onclick="applyPreset('shortTest')">Short Test</button>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-info" onclick="applyPreset('fullRange')">Full Range</button>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-info" onclick="applyPreset('precision')">Precision</button>
                    </div>
                </div>
                
                <div class="preset-group">
                    <h4>‚öôÔ∏è Custom Settings</h4>
                    <div class="input-group">
                        <label>Name:</label>
                        <input type="text" id="customName" placeholder="My Preset">
                    </div>
                    <div class="input-group">
                        <button class="btn btn-primary" onclick="saveCustomPreset()">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="loadCustomPreset()">üìÇ Load</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="sequence-section">
            <h2 class="section-title">üéØ Advanced Sequence Control</h2>
            <div class="sequence-controls">
                <div class="input-group">
                    <label>Delay Between:</label>
                    <input type="number" id="sequenceDelay" min="0" max="10000" value="0">
                    <span>ms</span>
                </div>
                <div class="input-group">
                    <label>Ramp Time:</label>
                    <input type="number" id="rampTime" min="0" max="5000" value="500">
                    <span>ms</span>
                </div>
            </div>
            <div class="sequence-controls">
                <button class="btn btn-info" onclick="testSequence()">üß™ Test Sequence</button>
                <button class="btn btn-primary" onclick="copyCurrentToClipboard()">üìã Copy Settings</button>
                <button class="btn btn-secondary" onclick="resetToDefaults()">üîÑ Reset All</button>
            </div>
        </div>
<div class="jog-section">
            <h2 class="section-title">üéÆ Manual Jog Control</h2>
            <div class="jog-buttons">
                <button class="jog-btn" onmousedown="startJog('M1', -100)" onmouseup="stopJog()" ontouchstart="startJog('M1', -100)" ontouchend="stopJog()">
                    ‚ÜñÔ∏è M1 Left
                </button>
                <button class="jog-btn" onmousedown="startJog('BOTH', -100)" onmouseup="stopJog()" ontouchstart="startJog('BOTH', -100)" ontouchend="stopJog()">
                    ‚¨ÜÔ∏è Both Up
                </button>
                <button class="jog-btn" onmousedown="startJog('M1', 100)" onmouseup="stopJog()" ontouchstart="startJog('M1', 100)" ontouchend="stopJog()">
                    ‚ÜóÔ∏è M1 Right
                </button>
                
                <button class="jog-btn" onmousedown="startJog('M2', -100)" onmouseup="stopJog()" ontouchstart="startJog('M2', -100)" ontouchend="stopJog()">
                    ‚¨ÖÔ∏è M2 Left
                </button>
                <button class="jog-btn" onclick="sendCommand('STOP')" style="background: #f44336;">
                    ‚èπÔ∏è STOP
                </button>
                <button class="jog-btn" onmousedown="startJog('M2', 100)" onmouseup="stopJog()" ontouchstart="startJog('M2', 100)" ontouchend="stopJog()">
                    ‚û°Ô∏è M2 Right
                </button>
                
                <button class="jog-btn" onmousedown="startJog('M1', -50)" onmouseup="stopJog()" ontouchstart="startJog('M1', -50)" ontouchend="stopJog()">
                    ‚ÜôÔ∏è M1 Slow L
                </button>
                <button class="jog-btn" onmousedown="startJog('BOTH', 100)" onmouseup="stopJog()" ontouchstart="startJog('BOTH', 100)" ontouchend="stopJog()">
                    ‚¨áÔ∏è Both Down
                </button>
                <button class="jog-btn" onmousedown="startJog('M1', 50)" onmouseup="stopJog()" ontouchstart="startJog('M1', 50)" ontouchend="stopJog()">
                    ‚ÜòÔ∏è M1 Slow R
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>üé¨ Professional Camera Slider Control System</p>
            <p>Compatible with ESP32 & Stepper Motors</p>
            <div style="margin-top: 10px; font-size: 0.9em;">
                <span id="lastCommand">Ready to connect...</span>
            </div>
        </div>
    </div>

    <script>
        let bluetoothDevice;
        let characteristic;
        let isConnected = false;
        let jogInterval;
        let lastJogCommand = '';
        
        // Preset configurations
        const presets = {
            slowPan: {
                m1Start: 0, m1End: 4000, m1Speed: 800,
                m2Start: 0, m2End: 3000, m2Speed: 600,
                cycles: 0, returnEnabled: true
            },
            fastMove: {
                m1Start: -1000, m1End: 3000, m1Speed: 4000,
                m2Start: -500, m2End: 2500, m2Speed: 3500,
                cycles: 3, returnEnabled: true
            },
            timeLoop: {
                m1Start: 0, m1End: 2000, m1Speed: 1200,
                m2Start: 0, m2End: 1500, m2Speed: 1000,
                cycles: 0, returnEnabled: true
            },
            shortTest: {
                m1Start: 0, m1End: 500, m1Speed: 1500,
                m2Start: 0, m2End: 300, m2Speed: 1200,
                cycles: 2, returnEnabled: true
            },
            fullRange: {
                m1Start: -5000, m1End: 5000, m1Speed: 5000,
                m2Start: -5000, m2End: 5000, m2Speed: 5000,
                cycles: 1, returnEnabled: false
            },
            precision: {
                m1Start: 100, m1End: 900, m1Speed: 400,
                m2Start: 50, m2End: 450, m2Speed: 300,
                cycles: 5, returnEnabled: true
            }
        };
// Initialize slider values
        function updateSliderValue(sliderId) {
            const slider = document.getElementById(sliderId);
            const valueSpan = document.getElementById(sliderId + 'Value');
            valueSpan.textContent = slider.value;
            
            // Send command to Arduino
            if (isConnected) {
                let command = '';
                switch(sliderId) {
                    case 'm1Start': command = `M1S:${slider.value}`; break;
                    case 'm1End': command = `M1E:${slider.value}`; break;
                    case 'm1Speed': command = `M1SPD:${slider.value}`; break;
                    case 'm2Start': command = `M2S:${slider.value}`; break;
                    case 'm2End': command = `M2E:${slider.value}`; break;
                    case 'm2Speed': command = `M2SPD:${slider.value}`; break;
                }
                if (command) sendCommand(command);
            }
        }
        
        function updateCyclesValue() {
            const slider = document.getElementById('cycles');
            const valueSpan = document.getElementById('cyclesValue');
            valueSpan.textContent = slider.value == 0 ? '‚àû' : slider.value;
            
            if (isConnected) {
                sendCommand(`CYCLES:${slider.value}`);
            }
        }
        
        function updateReturnEnabled() {
            const checkbox = document.getElementById('returnEnabled');
            if (isConnected) {
                sendCommand(`RETURN:${checkbox.checked ? 1 : 0}`);
            }
        }
        
        // Bluetooth connection
        async function connectBluetooth() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'CameraSlider' }],
                    optionalServices: ['12345678-1234-1234-1234-1234567890ab']
                });
                
                updateStatus('Connecting...', 'connecting');
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('12345678-1234-1234-1234-1234567890ab');
                characteristic = await service.getCharacteristic('abcd1234-1234-1234-1234-abcdef123456');
                
                bluetoothDevice = device;
                isConnected = true;
                updateStatus('Connected ‚úì', 'connected');
                updateLastCommand('Connected to Camera Slider');
                
                // Sync current values with Arduino
                syncAllValues();
                
            } catch (error) {
                console.error('Bluetooth connection failed:', error);
                updateStatus('Connection Failed', 'disconnected');
                updateLastCommand('Connection failed: ' + error.message);
            }
        }
        
        function updateStatus(text, className) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = text;
            statusElement.className = `connection-status ${className}`;
        }
        
        function updateLastCommand(text) {
            document.getElementById('lastCommand').textContent = text;
        }
function syncAllValues() {
            // Send all current slider values to Arduino
            const sliders = ['m1Start', 'm1End', 'm1Speed', 'm2Start', 'm2End', 'm2Speed'];
            sliders.forEach(sliderId => {
                updateSliderValue(sliderId);
            });
            updateCyclesValue();
            updateReturnEnabled();
        }
        
        function sendCommand(command) {
            if (!isConnected || !characteristic) {
                updateLastCommand('Not connected - ' + command);
                return;
            }
            
            try {
                const encoder = new TextEncoder();
                characteristic.writeValue(encoder.encode(command));
                updateLastCommand('Sent: ' + command);
                console.log('Sent command:', command);
            } catch (error) {
                console.error('Send failed:', error);
                updateLastCommand('Send failed: ' + command);
            }
        }
        
        // Jog control functions
        function startJog(axis, value) {
            if (jogInterval) clearInterval(jogInterval);
            
            const command = `JOGSLIDER:${axis}:${value}`;
            sendCommand(command);
            lastJogCommand = command;
            
            // Repeat command every 100ms for continuous jogging
            jogInterval = setInterval(() => {
                sendCommand(lastJogCommand);
            }, 100);
        }
        
        function stopJog() {
            if (jogInterval) {
                clearInterval(jogInterval);
                jogInterval = null;
            }
            
            // Send stop command for all axes
            sendCommand('JOGSLIDER:BOTH:0');
            updateLastCommand('Jog stopped');
        }
        
        // Preset functions
        function applyPreset(presetName) {
            if (!presets[presetName]) return;
            
            const preset = presets[presetName];
            
            // Update sliders
            document.getElementById('m1Start').value = preset.m1Start;
            document.getElementById('m1End').value = preset.m1End;
            document.getElementById('m1Speed').value = preset.m1Speed;
            document.getElementById('m2Start').value = preset.m2Start;
            document.getElementById('m2End').value = preset.m2End;
            document.getElementById('m2Speed').value = preset.m2Speed;
            document.getElementById('cycles').value = preset.cycles;
            document.getElementById('returnEnabled').checked = preset.returnEnabled;
            
            // Update displays
            updateSliderValue('m1Start');
            updateSliderValue('m1End');
            updateSliderValue('m1Speed');
            updateSliderValue('m2Start');
            updateSliderValue('m2End');
            updateSliderValue('m2Speed');
            updateCyclesValue();
            updateReturnEnabled();
            
            updateLastCommand(`Applied preset: ${presetName}`);
        }
function saveCustomPreset() {
            const name = document.getElementById('customName').value.trim();
            if (!name) {
                alert('Please enter a preset name');
                return;
            }
            
            const customPreset = {
                m1Start: parseInt(document.getElementById('m1Start').value),
                m1End: parseInt(document.getElementById('m1End').value),
                m1Speed: parseInt(document.getElementById('m1Speed').value),
                m2Start: parseInt(document.getElementById('m2Start').value),
                m2End: parseInt(document.getElementById('m2End').value),
                m2Speed: parseInt(document.getElementById('m2Speed').value),
                cycles: parseInt(document.getElementById('cycles').value),
                returnEnabled: document.getElementById('returnEnabled').checked
            };
            
            // Save to localStorage
            const savedPresets = JSON.parse(localStorage.getItem('customPresets') || '{}');
            savedPresets[name] = customPreset;
            localStorage.setItem('customPresets', JSON.stringify(savedPresets));
            
            updateLastCommand(`Saved preset: ${name}`);
            alert(`Preset "${name}" saved successfully!`);
        }
        
        function loadCustomPreset() {
            const name = document.getElementById('customName').value.trim();
            if (!name) {
                alert('Please enter a preset name to load');
                return;
            }
            
            const savedPresets = JSON.parse(localStorage.getItem('customPresets') || '{}');
            if (!savedPresets[name]) {
                alert(`Preset "${name}" not found`);
                return;
            }
            
            const preset = savedPresets[name];
            
            // Apply the preset
            document.getElementById('m1Start').value = preset.m1Start;
            document.getElementById('m1End').value = preset.m1End;
            document.getElementById('m1Speed').value = preset.m1Speed;
            document.getElementById('m2Start').value = preset.m2Start;
            document.getElementById('m2End').value = preset.m2End;
            document.getElementById('m2Speed').value = preset.m2Speed;
            document.getElementById('cycles').value = preset.cycles;
            document.getElementById('returnEnabled').checked = preset.returnEnabled;
            
            // Update displays and send to Arduino
            updateSliderValue('m1Start');
            updateSliderValue('m1End');
            updateSliderValue('m1Speed');
            updateSliderValue('m2Start');
            updateSliderValue('m2End');
            updateSliderValue('m2Speed');
            updateCyclesValue();
            updateReturnEnabled();
            
            updateLastCommand(`Loaded preset: ${name}`);
        }
        
        // Advanced sequence functions
        function testSequence() {
            if (!isConnected) {
                alert('Please connect to the slider first');
                return;
            }
            
            // Send test sequence with current settings
            const delay = document.getElementById('sequenceDelay').value;
            const ramp = document.getElementById('rampTime').value;
            
            sendCommand(`TEST_SEQ:${delay}:${ramp}`);
            updateLastCommand('Test sequence started');
        }
function sequenceLoop() {
            if (!isConnected) {
                alert('Please connect to the slider first');
                return;
            }
            
            // Send sequence loop command
            const loopCount = document.getElementById('loopCount').value;
            const pauseBetween = document.getElementById('pauseBetween').value;
            
            sendCommand(`SEQUENCE_LOOP:${loopCount}:${pauseBetween}`);
            updateLastCommand(`Sequence loop started: ${loopCount} cycles`);
        }
        
        // Initialize page
        window.addEventListener('load', function() {
            // Initialize all slider displays
            updateSliderValue('m1Start');
            updateSliderValue('m1End');
            updateSliderValue('m1Speed');
            updateSliderValue('m2Start');
            updateSliderValue('m2End');
            updateSliderValue('m2Speed');
            updateCyclesValue();
            
            // Check for Web Bluetooth support
            if (!navigator.bluetooth) {
                document.getElementById('connectBtn').disabled = true;
                updateStatus('Bluetooth not supported', 'disconnected');
            }
            
            // Load custom preset names from localStorage
            loadCustomPresetList();
            
            // Auto-hide jog buttons after inactivity
            setupJogInactivityTimer();
        });
        
        function loadCustomPresetList() {
            const savedPresets = JSON.parse(localStorage.getItem('customPresets') || '{}');
            const names = Object.keys(savedPresets);
            
            if (names.length > 0) {
                const datalist = document.createElement('datalist');
                datalist.id = 'presetNames';
                names.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    datalist.appendChild(option);
                });
                
                const input = document.getElementById('customName');
                input.setAttribute('list', 'presetNames');
                document.body.appendChild(datalist);
            }
        }
        
        function setupJogInactivityTimer() {
            let inactivityTimer;
            const jogButtons = document.querySelectorAll('.jog-btn');
            
            jogButtons.forEach(btn => {
                btn.addEventListener('mousedown', () => {
                    clearTimeout(inactivityTimer);
                });
                
                btn.addEventListener('mouseup', () => {
                    inactivityTimer = setTimeout(() => {
                        // Ensure motors are stopped after period of inactivity
                        if (isConnected) {
                            sendCommand('JOGSLIDER:BOTH:0');
                        }
                    }, 2000);
                });
            });
        }
// Emergency stop function
        function emergencyStop() {
            if (isConnected) {
                sendCommand('STOP');
                updateLastCommand('Emergency stop activated');
            }
        }
        
        // Set position functions
        function setCurrentAsStart(axis) {
            if (!isConnected) {
                alert('Please connect to the slider first');
                return;
            }
            
            const command = axis === 1 ? 'SET_M1_START' : 'SET_M2_START';
            sendCommand(command);
            updateLastCommand(`Set current position as ${axis === 1 ? 'M1' : 'M2'} start`);
        }
        
        function setCurrentAsEnd(axis) {
            if (!isConnected) {
                alert('Please connect to the slider first');
                return;
            }
            
            const command = axis === 1 ? 'SET_M1_END' : 'SET_M2_END';
            sendCommand(command);
            updateLastCommand(`Set current position as ${axis === 1 ? 'M1' : 'M2'} end`);
        }
        
        // Home function
        function homeSlider() {
            if (!isConnected) {
                alert('Please connect to the slider first');
                return;
            }
            
            sendCommand('HOME');
            updateLastCommand('Homing slider...');
        }
        
        // Run control functions
        function startRun() {
            if (!isConnected) {
                alert('Please connect to the slider first');
                return;
            }
            
            sendCommand('RUN');
            updateLastCommand('Run started');
        }
        
        function stopRun() {
            if (!isConnected) {
                alert('Please connect to the slider first');
                return;
            }
            
            sendCommand('STOP');
            updateLastCommand('Run stopped');
        }
        
        // Disconnect function
        function disconnect() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            
            isConnected = false;
            bluetoothDevice = null;
            characteristic = null;
            
            updateStatus('Disconnected', 'disconnected');
            updateLastCommand('Disconnected from slider');
        }
// Status update functions
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateLastCommand(message) {
            document.getElementById('lastCommand').textContent = message;
        }
        
        // Battery monitoring (if implemented in Arduino)
        function requestBatteryStatus() {
            if (isConnected) {
                sendCommand('BATTERY_STATUS');
                updateLastCommand('Battery status requested');
            }
        }
        
        // Position monitoring
        function requestPosition() {
            if (isConnected) {
                sendCommand('GET_POSITION');
                updateLastCommand('Position requested');
            }
        }
        
        // Auto-sync function
        function enableAutoSync() {
            if (autoSyncInterval) clearInterval(autoSyncInterval);
            
            autoSyncInterval = setInterval(() => {
                if (isConnected) {
                    syncAllValues();
                }
            }, 5000); // Sync every 5 seconds
        }
        
        function disableAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
        }
        
        // Touch/mobile support for jog buttons
        function setupTouchSupport() {
            const jogButtons = document.querySelectorAll('.jog-btn');
            
            jogButtons.forEach(btn => {
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    btn.dispatchEvent(new Event('mousedown'));
                });
                
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    btn.dispatchEvent(new Event('mouseup'));
                });
            });
        }
        
        // Call touch setup after page load
        window.addEventListener('load', setupTouchSupport);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (!isConnected) return;
            
            switch(e.key) {
                case 'r':
                case 'R':
                    startRun();
                    break;
                case 's':
                case 'S':
                    stopRun();
                    break;
                case 'h':
                case 'H':
                    homeSlider();
                    break;
                case ' ':
                    e.preventDefault();
                    emergencyStop();
                    break;
            }
        });
// Data logging functionality
        let logData = [];
        const MAX_LOG_ENTRIES = 100;
        
        function logEvent(event, data = '') {
            const timestamp = new Date().toISOString();
            const entry = {
                timestamp,
                event,
                data,
                id: Date.now()
            };
            
            logData.unshift(entry); // Add to beginning
            if (logData.length > MAX_LOG_ENTRIES) {
                logData.pop(); // Remove oldest entry
            }
            
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logContainer = document.getElementById('logContainer');
            if (!logContainer) return;
            
            logContainer.innerHTML = logData.slice(0, 10).map(entry => `
                <div class="log-entry">
                    <span class="log-time">${new Date(entry.timestamp).toLocaleTimeString()}</span>
                    <span class="log-event">${entry.event}</span>
                    <span class="log-data">${entry.data}</span>
                </div>
            `).join('');
        }
        
        function exportLog() {
            const csv = 'Timestamp,Event,Data\n' + 
                logData.map(entry => `"${entry.timestamp}","${entry.event}","${entry.data}"`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `slider-log-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            URL.revokeObjectURL(url);
        }
        
        function clearLog() {
            logData = [];
            updateLogDisplay();
        }
        
        // Enhanced error handling
        function handleConnectionError(error) {
            console.error('Connection error:', error);
            
            let message = 'Connection failed';
            if (error.message.includes('User cancelled')) {
                message = 'Connection cancelled by user';
            } else if (error.message.includes('not found')) {
                message = 'Device not found - check if slider is on';
            } else if (error.message.includes('GATT')) {
                message = 'Bluetooth connection lost';
            }
            
            updateStatus(message, 'error');
            logEvent('ERROR', message);
            
            // Reset connection state
            isConnected = false;
            bluetoothDevice = null;
            characteristic = null;
        }
        
        // Performance monitoring
        let commandQueue = [];
        let isProcessingQueue = false;
        
        function queueCommand(command) {
            commandQueue.push({
                command,
                timestamp: Date.now()
            });
            
            processCommandQueue();
        }
        
        async function processCommandQueue() {
            if (isProcessingQueue || commandQueue.length === 0) return;
            
            isProcessingQueue = true;
            
            while (commandQueue.length > 0) {
                const { command, timestamp } = commandQueue.shift();
                
                // Skip old commands (older than 500ms)
                if (Date.now() - timestamp > 500) {
                    continue;
                }
                
                try {
                    await sendCommand(command);
                    await new Promise(resolve => setTimeout(resolve, 50)); // Small delay between commands
                } catch (error) {
                    console.error('Command failed:', error);
                }
            }
            
            isProcessingQueue = false;
        }
// Advanced configuration options
        function showAdvancedConfig() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Advanced Configuration</h3>
                    <div class="config-section">
                        <h4>Connection Settings</h4>
                        <label>
                            Auto-reconnect: 
                            <input type="checkbox" id="autoReconnect" checked>
                        </label>
                        <label>
                            Connection timeout (ms): 
                            <input type="number" id="connectionTimeout" value="10000" min="1000" max="30000">
                        </label>
                    </div>
                    
                    <div class="config-section">
                        <h4>Jog Settings</h4>
                        <label>
                            Jog acceleration: 
                            <input type="range" id="jogAccel" min="0.1" max="2" step="0.1" value="1">
                            <span id="jogAccelValue">1</span>
                        </label>
                        <label>
                            Max jog speed: 
                            <input type="number" id="maxJogSpeed" value="600" min="100" max="2000">
                        </label>
                    </div>
                    
                    <div class="config-section">
                        <h4>UI Settings</h4>
                        <label>
                            Theme: 
                            <select id="uiTheme">
                                <option value="dark">Dark</option>
                                <option value="light">Light</option>
                                <option value="auto">Auto</option>
                            </select>
                        </label>
                        <label>
                            Show debug info: 
                            <input type="checkbox" id="showDebug">
                        </label>
                    </div>
                    
                    <div class="modal-buttons">
                        <button onclick="saveAdvancedConfig()">Save</button>
                        <button onclick="closeModal()">Cancel</button>
                        <button onclick="resetAdvancedConfig()">Reset to Defaults</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            loadAdvancedConfig();
        }
        
        function loadAdvancedConfig() {
            const config = JSON.parse(localStorage.getItem('advancedConfig') || '{}');
            
            document.getElementById('autoReconnect').checked = config.autoReconnect !== false;
            document.getElementById('connectionTimeout').value = config.connectionTimeout || 10000;
            document.getElementById('jogAccel').value = config.jogAccel || 1;
            document.getElementById('jogAccelValue').textContent = config.jogAccel || 1;
            document.getElementById('maxJogSpeed').value = config.maxJogSpeed || 600;
            document.getElementById('uiTheme').value = config.uiTheme || 'dark';
            document.getElementById('showDebug').checked = config.showDebug || false;
            
            // Update jog accel display
            document.getElementById('jogAccel').addEventListener('input', (e) => {
                document.getElementById('jogAccelValue').textContent = e.target.value;
            });
        }
        
        function saveAdvancedConfig() {
            const config = {
                autoReconnect: document.getElementById('autoReconnect').checked,
                connectionTimeout: parseInt(document.getElementById('connectionTimeout').value),
                jogAccel: parseFloat(document.getElementById('jogAccel').value),
                maxJogSpeed: parseInt(document.getElementById('maxJogSpeed').value),
                uiTheme: document.getElementById('uiTheme').value,
                showDebug: document.getElementById('showDebug').checked
            };
            
            localStorage.setItem('advancedConfig', JSON.stringify(config));
            applyAdvancedConfig(config);
            closeModal();
        }
        
        function resetAdvancedConfig() {
            localStorage.removeItem('advancedConfig');
            loadAdvancedConfig();
        }
        
        function applyAdvancedConfig(config) {
            // Apply theme
            document.body.setAttribute('data-theme', config.uiTheme);
            
            // Apply debug mode
            const debugElements = document.querySelectorAll('.debug-info');
            debugElements.forEach(el => {
                el.style.display = config.showDebug ? 'block' : 'none';
            });
            
            // Store for use in jog functions
            window.advancedConfig = config;
        }
        
        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }
// Preset management
        let presets = JSON.parse(localStorage.getItem('sliderPresets') || '[]');
        
        function showPresetManager() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Preset Manager</h3>
                    <div class="preset-actions">
                        <button onclick="saveCurrentAsPreset()">Save Current Settings</button>
                        <button onclick="exportPresets()">Export All</button>
                        <button onclick="importPresets()">Import</button>
                    </div>
                    
                    <div class="preset-list" id="presetList">
                        ${renderPresetList()}
                    </div>
                    
                    <div class="modal-buttons">
                        <button onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function renderPresetList() {
            if (presets.length === 0) {
                return '<p>No presets saved</p>';
            }
            
            return presets.map((preset, index) => `
                <div class="preset-item">
                    <div class="preset-info">
                        <h4>${preset.name}</h4>
                        <small>${new Date(preset.timestamp).toLocaleDateString()}</small>
                        <div class="preset-details">
                            M1: ${preset.settings.m1Start}-${preset.settings.m1End} @ ${preset.settings.m1Speed} |
                            M2: ${preset.settings.m2Start}-${preset.settings.m2End} @ ${preset.settings.m2Speed}
                        </div>
                    </div>
                    <div class="preset-actions">
                        <button onclick="loadPreset(${index})">Load</button>
                        <button onclick="deletePreset(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function saveCurrentAsPreset() {
            const name = prompt('Enter preset name:');
            if (!name) return;
            
            const currentSettings = getCurrentSettings();
            const preset = {
                name,
                timestamp: Date.now(),
                settings: currentSettings
            };
            
            presets.push(preset);
            localStorage.setItem('sliderPresets', JSON.stringify(presets));
            
            // Refresh preset list if modal is open
            const presetList = document.getElementById('presetList');
            if (presetList) {
                presetList.innerHTML = renderPresetList();
            }
            
            logEvent('PRESET_SAVED', name);
        }
        
        function getCurrentSettings() {
            return {
                m1Start: parseInt(document.getElementById('m1Start').value) || 0,
                m1End: parseInt(document.getElementById('m1End').value) || 2000,
                m1Speed: parseInt(document.getElementById('m1Speed').value) || 2000,
                m2Start: parseInt(document.getElementById('m2Start').value) || 0,
                m2End: parseInt(document.getElementById('m2End').value) || 2000,
                m2Speed: parseInt(document.getElementById('m2Speed').value) || 2000,
                cycles: parseInt(document.getElementById('cycles').value) || 0,
                returnEnabled: document.getElementById('returnEnabled').checked
            };
        }
        
        function loadPreset(index) {
            const preset = presets[index];
            if (!preset) return;
            
            // Apply settings to UI
            document.getElementById('m1Start').value = preset.settings.m1Start;
            document.getElementById('m1End').value = preset.settings.m1End;
            document.getElementById('m1Speed').value = preset.settings.m1Speed;
            document.getElementById('m2Start').value = preset.settings.m2Start;
            document.getElementById('m2End').value = preset.settings.m2End;
            document.getElementById('m2Speed').value = preset.settings.m2Speed;
            document.getElementById('cycles').value = preset.settings.cycles;
            document.getElementById('returnEnabled').checked = preset.settings.returnEnabled;
            
            // Sync with Arduino
            syncAllValues();
            
            closeModal();
            logEvent('PRESET_LOADED', preset.name);
        }
        
        function deletePreset(index) {
            if (!confirm('Delete this preset?')) return;
            
            const deletedName = presets[index].name;
            presets.splice(index, 1);
            localStorage.setItem('sliderPresets', JSON.stringify(presets));
            
            // Refresh preset list
            const presetList = document.getElementById('presetList');
            if (presetList) {
                presetList.innerHTML = renderPresetList();
            }
            
            logEvent('PRESET_DELETED', deletedName);
        }
        
        function exportPresets() {
            const data = {
                version: '1.0',
                timestamp: Date.now(),
                presets: presets
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `slider-presets-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            logEvent('PRESETS_EXPORTED', presets.length + ' presets');
        }
        
        function importPresets() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.presets && Array.isArray(data.presets)) {
                            presets = [...presets, ...data.presets];
                            localStorage.setItem('sliderPresets', JSON.stringify(presets));
                            
                            // Refresh preset list
                            const presetList = document.getElementById('presetList');
                            if (presetList) {
                                presetList.innerHTML = renderPresetList();
                            }
                            
                            logEvent('PRESETS_IMPORTED', data.presets.length + ' presets');
                        } else {
                            throw new Error('Invalid file format');
                        }
                    } catch (error) {
                        alert('Error importing presets: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
// Real-time monitoring and feedback
        function startStatusMonitoring() {
            if (statusInterval) clearInterval(statusInterval);
            
            statusInterval = setInterval(() => {
                if (isConnected && !isProcessingQueue) {
                    requestStatusUpdate();
                }
            }, 1000); // Request status every second
        }
        
        function stopStatusMonitoring() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }
        
        function requestStatusUpdate() {
            queueCommand('STATUS');
        }
        
        // Enhanced position tracking
        let positionHistory = [];
        const MAX_POSITION_HISTORY = 50;
        
        function updatePositionHistory(m1Pos, m2Pos) {
            const timestamp = Date.now();
            positionHistory.unshift({ timestamp, m1: m1Pos, m2: m2Pos });
            
            if (positionHistory.length > MAX_POSITION_HISTORY) {
                positionHistory.pop();
            }
            
            updatePositionChart();
        }
        
        function updatePositionChart() {
            const chartContainer = document.getElementById('positionChart');
            if (!chartContainer || positionHistory.length < 2) return;
            
            const canvas = chartContainer.querySelector('canvas') || document.createElement('canvas');
            if (!chartContainer.contains(canvas)) {
                canvas.width = 300;
                canvas.height = 150;
                chartContainer.appendChild(canvas);
            }
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 10; i++) {
                const x = (canvas.width / 10) * i;
                const y = (canvas.height / 10) * i;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            if (positionHistory.length < 2) return;
            
            // Find position range
            const positions = positionHistory.map(h => [h.m1, h.m2]).flat();
            const minPos = Math.min(...positions);
            const maxPos = Math.max(...positions);
            const range = maxPos - minPos || 1;
            
            // Draw M1 line
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 2;
            ctx.beginPath();
            positionHistory.forEach((point, i) => {
                const x = canvas.width - (i / (positionHistory.length - 1)) * canvas.width;
                const y = canvas.height - ((point.m1 - minPos) / range) * canvas.height;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // Draw M2 line
            ctx.strokeStyle = '#4ecdc4';
            ctx.lineWidth = 2;
            ctx.beginPath();
            positionHistory.forEach((point, i) => {
                const x = canvas.width - (i / (positionHistory.length - 1)) * canvas.width;
                const y = canvas.height - ((point.m2 - minPos) / range) * canvas.height;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }
        
        // Speed monitoring
        let speedHistory = [];
        function updateSpeedDisplay(m1Speed, m2Speed) {
            document.getElementById('m1CurrentSpeed').textContent = Math.round(m1Speed);
            document.getElementById('m2CurrentSpeed').textContent = Math.round(m2Speed);
            
            speedHistory.unshift({ timestamp: Date.now(), m1: m1Speed, m2: m2Speed });
            if (speedHistory.length > 20) speedHistory.pop();
            
            // Update speed bars
            const maxSpeed = Math.max(m1Speed, m2Speed, 100);
            document.getElementById('m1SpeedBar').style.width = `${(Math.abs(m1Speed) / maxSpeed) * 100}%`;
            document.getElementById('m2SpeedBar').style.width = `${(Math.abs(m2Speed) / maxSpeed) * 100}%`;
        }
        
        // Emergency procedures
        function handleEmergencyStop() {
            if (!isConnected) return;
            
            // Immediate stop
            sendCommand('STOP');
            
            // Reset jog states
            targetSpeedM1 = targetSpeedM2 = 0;
            isJogging = false;
            
            // Clear any queued commands
            commandQueue = [];
            
            // Update UI
            updateStatus('Emergency stop activated', 'error');
            logEvent('EMERGENCY_STOP', 'User initiated');
            
            // Show emergency dialog
            showEmergencyDialog();
        }
        
        function showEmergencyDialog() {
            const modal = document.createElement('div');
            modal.className = 'modal emergency-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Emergency Stop Activated</h3>
                    <p>All motion has been stopped. Please check the slider and camera setup before continuing.</p>
                    <div class="emergency-actions">
                        <button onclick="resumeAfterEmergency()" class="btn-primary">Resume Operations</button>
                        <button onclick="homeAfterEmergency()" class="btn-secondary">Home Slider</button>
                        <button onclick="closeModal()" class="btn-danger">Stay Stopped</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function resumeAfterEmergency() {
            updateStatus('Operations resumed', 'success');
            logEvent('EMERGENCY_RESUME', 'User resumed after emergency stop');
            closeModal();
        }
        
        function homeAfterEmergency() {
            homeSlider();
            logEvent('EMERGENCY_HOME', 'Homing after emergency stop');
            closeModal();
        }
// Keyboard shortcuts and accessibility
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return; // Don't interfere with input fields
            
            switch(e.key.toLowerCase()) {
                case ' ':
                    e.preventDefault();
                    if (isConnected) {
                        if (running) togglePause();
                        else startSlider();
                    }
                    break;
                    
                case 'h':
                    if (isConnected) homeSlider();
                    break;
                    
                case 's':
                    if (isConnected) stopSlider();
                    break;
                    
                case 'c':
                    if (isConnected) connectBluetooth();
                    else connectBluetooth();
                    break;
                    
                case 'escape':
                    if (isConnected) handleEmergencyStop();
                    break;
                    
                case 'arrowleft':
                    e.preventDefault();
                    if (isConnected) jogM1(-1);
                    break;
                    
                case 'arrowright':
                    e.preventDefault();
                    if (isConnected) jogM1(1);
                    break;
                    
                case 'arrowup':
                    e.preventDefault();
                    if (isConnected) jogM2(1);
                    break;
                    
                case 'arrowdown':
                    e.preventDefault();
                    if (isConnected) jogM2(-1);
                    break;
            }
        });
        
        document.addEventListener('keyup', (e) => {
            switch(e.key.toLowerCase()) {
                case 'arrowleft':
                case 'arrowright':
                    if (isConnected) stopJogM1();
                    break;
                    
                case 'arrowup':
                case 'arrowdown':
                    if (isConnected) stopJogM2();
                    break;
            }
        });
        
        // Touch/mobile support
        function addTouchSupport() {
            const jogButtons = document.querySelectorAll('.jog-btn');
            
            jogButtons.forEach(btn => {
                let touchStarted = false;
                
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    touchStarted = true;
                    btn.click();
                });
                
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (touchStarted) {
                        // Trigger button release action
                        const motor = btn.dataset.motor;
                        if (motor === 'm1') stopJogM1();
                        else if (motor === 'm2') stopJogM2();
                        touchStarted = false;
                    }
                });
                
                btn.addEventListener('touchcancel', (e) => {
                    if (touchStarted) {
                        const motor = btn.dataset.motor;
                        if (motor === 'm1') stopJogM1();
                        else if (motor === 'm2') stopJogM2();
                        touchStarted = false;
                    }
                });
            });
        }
        
        // Auto-save functionality
        let autoSaveTimer;
        function scheduleAutoSave() {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                if (isConnected) {
                    syncAllValues();
                    logEvent('AUTO_SAVE', 'Settings synced');
                }
            }, 2000); // Auto-save 2 seconds after last change
        }
        
        // Add event listeners for auto-save
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('input[type="number"], input[type="range"], input[type="checkbox"]');
            inputs.forEach(input => {
                input.addEventListener('change', scheduleAutoSave);
            });
        });
        
        // Performance optimization
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }
        
        // Throttled position update for smooth UI
        const throttledPositionUpdate = throttle(updatePositionDisplay, 100);
        
        // Network status monitoring
        let isOnline = navigator.onLine;
        
        window.addEventListener('online', () => {
            isOnline = true;
            updateNetworkStatus();
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            updateNetworkStatus();
        });
        
        function updateNetworkStatus() {
            const statusElement = document.getElementById('networkStatus');
            if (statusElement) {
                statusElement.textContent = isOnline ? 'Online' : 'Offline';
                statusElement.className = isOnline ? 'status-online' : 'status-offline';
            }
        }
        
        // Battery status for mobile devices
        if ('getBattery' in navigator) {
            navigator.getBattery().then(battery => {
                function updateBatteryStatus() {
                    const level = Math.round(battery.level * 100);
                    const charging = battery.charging;
                    
                    const batteryElement = document.getElementById('batteryStatus');
                    if (batteryElement) {
                        batteryElement.textContent = `${level}% ${charging ? 'üîå' : 'üîã'}`;
                    }
                }
                
                battery.addEventListener('levelchange', updateBatteryStatus);
                battery.addEventListener('chargingchange', updateBatteryStatus);
                updateBatteryStatus();
            });
        }
// Final initialization and startup
        function initializeApp() {
            // Load saved configurations
            const savedConfig = JSON.parse(localStorage.getItem('advancedConfig') || '{}');
            applyAdvancedConfig(savedConfig);
            
            // Initialize UI components
            addTouchSupport();
            updateNetworkStatus();
            
            // Set up periodic tasks
            startStatusMonitoring();
            
            // Initialize help system
            initializeHelp();
            
            // Show welcome message for first-time users
            if (!localStorage.getItem('hasVisited')) {
                showWelcomeDialog();
                localStorage.setItem('hasVisited', 'true');
            }
            
            logEvent('APP_INITIALIZED', 'Application started successfully');
        }
        
        function showWelcomeDialog() {
            const modal = document.createElement('div');
            modal.className = 'modal welcome-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Welcome to Camera Slider Control</h3>
                    <div class="welcome-content">
                        <h4>Quick Start:</h4>
                        <ol>
                            <li>Click <strong>Connect</strong> to pair with your slider</li>
                            <li>Set your <strong>start/end positions</strong> and <strong>speeds</strong></li>
                            <li>Use <strong>Jog</strong> controls to test movement</li>
                            <li>Click <strong>Start</strong> to begin automated movement</li>
                        </ol>
                        
                        <h4>Keyboard Shortcuts:</h4>
                        <ul>
                            <li><strong>Space</strong>: Start/Pause</li>
                            <li><strong>H</strong>: Home slider</li>
                            <li><strong>S</strong>: Stop</li>
                            <li><strong>ESC</strong>: Emergency stop</li>
                            <li><strong>Arrow keys</strong>: Jog controls</li>
                        </ul>
                        
                        <div class="welcome-tips">
                            <p><strong>üí° Tip:</strong> Use the preset manager to save your favorite settings!</p>
                        </div>
                    </div>
                    
                    <div class="modal-buttons">
                        <button onclick="closeModal()" class="btn-primary">Get Started</button>
                        <button onclick="showAdvancedConfig(); closeModal();">Settings</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function initializeHelp() {
            // Add help tooltips to key elements
            const helpItems = [
                { id: 'connectBtn', text: 'Connect to your Arduino camera slider via Bluetooth' },
                { id: 'startBtn', text: 'Start the automated slider movement sequence' },
                { id: 'homeBtn', text: 'Move both motors to their zero position' },
                { id: 'emergencyBtn', text: 'Immediately stop all movement - use in emergencies' },
                { id: 'm1Start', text: 'Starting position for Motor 1 (steps from zero)' },
                { id: 'm1End', text: 'Ending position for Motor 1 (steps from zero)' },
                { id: 'm1Speed', text: 'Maximum speed for Motor 1 (steps per second)' }
            ];
            
            helpItems.forEach(item => {
                const element = document.getElementById(item.id);
                if (element) {
                    element.title = item.text;
                    element.setAttribute('data-help', item.text);
                }
            });
        }
        
        // Final cleanup and error handling
        window.addEventListener('beforeunload', () => {
            if (isConnected) {
                // Send stop command before page closes
                sendCommand('STOP');
                logEvent('APP_CLOSING', 'Page unload detected');
            }
            
            // Clear intervals
            stopStatusMonitoring();
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
        });
        
        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            logEvent('ERROR', event.error.message);
            
            // Show user-friendly error message
            updateStatus('An error occurred. Check console for details.', 'error');
        });
        
        // Promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            logEvent('PROMISE_REJECTION', event.reason);
        });
        
        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            
            // Final UI setup
            document.body.setAttribute('data-theme', 'dark');
            
            console.log('Camera Slider Control initialized successfully');
        });
    </script>
</body>
</html>








