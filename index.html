#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>

// ================= BLE UUIDs (DO NOT CHANGE) =================
#define SERVICE_UUID        "12345678-1234-1234-1234-1234567890ab"
#define CHARACTERISTIC_UUID "abcd1234-1234-1234-1234-abcdef123456"

// ================= STATE VARIABLES =================
int M1_START = 0;
int M1_END   = 0;
int M2_START = 0;
int M2_END   = 0;
int CYCLES   = 0;   // 0 = infinite

bool running = false;
String trackMode = "NONE"; // M1 / M2 / BOTH

BLECharacteristic* pCharacteristic;

// ================= BLE CALLBACKS =================
class ServerCallbacks : public BLEServerCallbacks {
  void onConnect(BLEServer* pServer) {
    Serial.println("BLE Connected");
  }

  void onDisconnect(BLEServer* pServer) {
    Serial.println("BLE Disconnected");
    BLEDevice::startAdvertising();
  }
};

class CharacteristicCallbacks : public BLECharacteristicCallbacks {
  void onWrite(BLECharacteristic* pChar) {

    String cmd = pChar->getValue().c_str();
    cmd.trim();

    if (cmd.length() == 0) return;

    Serial.print("BLE CMD: ");
    Serial.println(cmd);

    // ---------- COMMANDS ----------
    if (cmd == "RUN") {
      running = true;
      Serial.println("RUNNING");
    }
    else if (cmd == "STOP") {
      running = false;
      Serial.println("STOPPED");
    }
    else if (cmd == "TRACK:M1") {
      trackMode = "M1";
      Serial.println("TRACK MODE: M1");
    }
    else if (cmd == "TRACK:M2") {
      trackMode = "M2";
      Serial.println("TRACK MODE: M2");
    }
    else if (cmd == "TRACK:BOTH") {
      trackMode = "BOTH";
      Serial.println("TRACK MODE: BOTH");
    }

    // ---------- VALUES ----------
    else if (cmd.startsWith("M1S:")) {
      M1_START = cmd.substring(4).toInt();
      Serial.print("M1 START = ");
      Serial.println(M1_START);
    }
    else if (cmd.startsWith("M1E:")) {
      M1_END = cmd.substring(4).toInt();
      Serial.print("M1 END = ");
      Serial.println(M1_END);
    }
    else if (cmd.startsWith("M2S:")) {
      M2_START = cmd.substring(4).toInt();
      Serial.print("M2 START = ");
      Serial.println(M2_START);
    }
    else if (cmd.startsWith("M2E:")) {
      M2_END = cmd.substring(4).toInt();
      Serial.print("M2 END = ");
      Serial.println(M2_END);
    }
    else if (cmd.startsWith("CYC:")) {
      CYCLES = cmd.substring(4).toInt();
      Serial.print("CYCLES = ");
      Serial.println(CYCLES == 0 ? "INF" : String(CYCLES));
    }
  }
};

// ================= SETUP =================
void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("Starting BLE");

  BLEDevice::init("CameraSlider");

  BLEServer* pServer = BLEDevice::createServer();
  pServer->setCallbacks(new ServerCallbacks());

  BLEService* pService = pServer->createService(SERVICE_UUID);

  pCharacteristic = pService->createCharacteristic(
    CHARACTERISTIC_UUID,
    BLECharacteristic::PROPERTY_WRITE
  );

  pCharacteristic->setCallbacks(new CharacteristicCallbacks());

  pService->start();
  BLEDevice::startAdvertising();

  Serial.println("BLE Advertising");
}

// ================= LOOP =================
void loop() {
  if (running) {
    // Placeholder for motor logic later
    // We will add this ONLY after BLE + commands are proven solid
  }
}



